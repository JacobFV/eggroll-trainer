name: Release to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # For trusted publishing
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install build dependencies
      run: |
        uv pip install build twine
    
    - name: Extract version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
    
    - name: Verify version in pyproject.toml
      run: |
        CURRENT_VERSION=$(grep '^version =' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        EXPECTED_VERSION="${{ steps.version.outputs.version }}"
        if [ "$CURRENT_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "❌ Version mismatch!"
          echo "   pyproject.toml: $CURRENT_VERSION"
          echo "   Expected: $EXPECTED_VERSION"
          exit 1
        fi
        echo "✓ Version matches: $CURRENT_VERSION"
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package contents
      run: |
        echo "Built files:"
        ls -lh dist/
        echo ""
        echo "Package contents:"
        python -m zipfile -l dist/*.whl | head -20
    
    - name: Publish to TestPyPI
      if: github.event_name == 'workflow_dispatch'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
      run: |
        echo "Publishing to TestPyPI..."
        python -m twine upload --verbose dist/*
    
    - name: Publish to PyPI
      if: github.event_name == 'release'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."
        python -m twine upload --verbose dist/*
    
    - name: Create GitHub Release Notes
      if: github.event_name == 'release'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const version = '${{ steps.version.outputs.version }}';
          
          // Read CHANGELOG if it exists, or generate basic notes
          let releaseNotes = `## Version ${version}\n\n`;
          
          try {
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            // Extract relevant section (simplified)
            releaseNotes += changelog;
          } catch (e) {
            releaseNotes += `Release ${version} of eggroll-trainer.\n\n`;
            releaseNotes += `### Installation\n`;
            releaseNotes += `\`\`\`bash\npip install eggroll-trainer==${version}\n\`\`\`\n`;
          }
          
          github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id,
            body: releaseNotes
          });

